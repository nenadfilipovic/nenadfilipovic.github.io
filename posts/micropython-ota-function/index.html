<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><title>Micropython Ota Function - Diy &amp; Code</title><meta name=description content="I assume you have built your esp-open-sdk and you know how to compile micropython firmware, if you dont know how check older posts. Installation procedure goes like this.
Download yaota8266 and axtls repositories.
Create esp8266ota folder and extract yaota8266 repository in it. Then navigate to esp8266ota/yaota8266/ota_server/lib/axtls and extract axtls repository there. I have tried to clone yaota8266 repository but it was giving me empty axtls folder so I had to do it manually."><meta name=author content="Nenad Filipovic"><link rel=canonical href=https://mydiy.space/posts/micropython-ota-function/><link rel=icon href=/favicon.png type=image/png><link rel=stylesheet href=https://mydiy.space/styles/main.min.7b09a3000a92b7972869a40fce54226739fd6713c5961c97f49c5da0ed9e318c.css integrity="sha256-ewmjAAqSt5coaaQPzlQiZzn9ZxPFlhyX9JxdoO2eMYw="><meta property=og:title content="Micropython Ota Function"><meta property=og:description content="I assume you have built your esp-open-sdk and you know how to compile micropython firmware, if you dont know how check older posts. Installation procedure goes like this.
Download yaota8266 and axtls repositories.
Create esp8266ota folder and extract yaota8266 repository in it. Then navigate to esp8266ota/yaota8266/ota_server/lib/axtls and extract axtls repository there. I have tried to clone yaota8266 repository but it was giving me empty axtls folder so I had to do it manually."><meta property=og:type content=article><meta property=og:url content=https://mydiy.space/posts/micropython-ota-function/><meta property=article:published_time content=2019-10-07T20:40:24+02:00><meta property=article:modified_time content=2019-10-07T20:40:24+02:00><meta name=twitter:card content=summary><meta name=twitter:title content="Micropython Ota Function"><meta name=twitter:description content="I assume you have built your esp-open-sdk and you know how to compile micropython firmware, if you dont know how check older posts. Installation procedure goes like this.
Download yaota8266 and axtls repositories.
Create esp8266ota folder and extract yaota8266 repository in it. Then navigate to esp8266ota/yaota8266/ota_server/lib/axtls and extract axtls repository there. I have tried to clone yaota8266 repository but it was giving me empty axtls folder so I had to do it manually."><link href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,300italic,400italic|Raleway:500,100,300" rel=stylesheet><link href=https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/feather-icons/4.28.0/feather.min.js></script><script src=https://rawcdn.githack.com/nextapps-de/spotlight/0.6.3/dist/spotlight.bundle.js></script></head><body><div class="container wrapper post"><div class=header><h1 class=site-title>Diy &amp; Code</h1><div class=site-description><h2>Personal blog about <a href=https://github.com/nenadfilipovic>electronics / diy / programming</a></h2><nav class="nav social"><ul class=flat><a href=https://github.com/nenadfilipovic title=Github><i data-feather=github></i></a><a href=https://gitlab.com/nenadfilipovic title=Gitlab><i data-feather=gitlab></i></a><a href=mailto:contact@nenadfilipovic.site title=Email><i data-feather=mail></i></a><a href=/index.xml title=RSS><i data-feather=rss></i></a></ul></nav></div><nav class=nav><ul class=flat><li><a href=/>Home</a></li><li><a href=/posts>All posts</a></li><li><a href=/about>About</a></li><li><a href=/tags>Tags</a></li></ul></nav></div><div class=post-header><h1 class=title>Micropython Ota Function</h1><div class=meta>Posted at &mdash; Oct 7, 2019</div></div><div class=markdown><p>I assume you have built your esp-open-sdk and you know how to compile micropython firmware, if you dont know how check older posts.
Installation procedure goes like this.</p><p>Download <a href=https://github.com/pfalcon/yaota8266>yaota8266</a> and <a href=https://github.com/pfalcon/axtls/tree/3c6b62b718427c03c345ee15be9bb66959a34ccd>axtls</a> repositories.</p><p>Create esp8266ota folder and extract yaota8266 repository in it. Then navigate to <code>esp8266ota/yaota8266/ota_server/lib/axtls</code> and extract axtls repository there.
I have tried to clone yaota8266 repository but it was giving me empty axtls folder so I had to do it manually.</p><p>To generate your keys in ota_client folder run this code.</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#000;font-weight:700>.</span>gen_keys<span style=color:#000;font-weight:700>.</span>sh
python <span style=color:#000;font-weight:700>-</span>c <span style=color:#d14>&#34;import rsa_sign; rsa_sign.dump_c(rsa_sign.load_key())&#34;</span></code></pre></div><p>Terminal will show you some values and you need mod value.
You need to keep priv.key and pub.key in same location as your ota_client.py or else it wont be able to authenticate and ota will fail.
Copy mod value to modulus field in config.h.example and rename file to config.h.</p><p>Prepare new sdk and check for updates, change folder to esp-open-sdk and run make clean,
then check if there is any update to it with git.</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>git pull
git submodule sync
git submodule update</code></pre></div><p>Copy etshal.h and boot8266.ld from patch folder to your boot8266 folder and replace old files.
Also copy ota.ld from patch folder to your ota_server folder and replace old file.</p><p>From root of yaota8266 folder run make.
In root folder yaota8266.bin will be created, save it somewhere.
Go to <code>micropython/port/esp8266</code> folder and run make ota.
In build folder firmware-ota.bin will be created, put it next to yaota8266.bin.</p><p>Using esptool flash ota server and ota firmware with these commands.</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>esptool.py --port your-port --baud <span style=color:#099>230400</span> write_flash -fm dio --flash_size <span style=color:#000;font-weight:700>=</span> detect 0x0 yaota8266.bin
esptool.py --port your-port --baud <span style=color:#099>230400</span> write_flash -fm dio --flash_size <span style=color:#000;font-weight:700>=</span> detect 0x3c000 firmware-ota.bin</code></pre></div><p>To flash firmware by ota restart esp8266 board and in next 3 seconds press flash button to enter ota mode. I am using NodeMCU V3 board, for other boards google which pins you need to use to activate it.</p><p>Connect board to internet and get its ip address.
On PC execute this command and change ip address and filename to your board ip and your generated firmware filename.</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>python ota_client.py -a <span style=color:#099>196</span>.182.12.10 live-ota myfirmware.bin</code></pre></div><p>In terminal you will see send requests and receive messages and hopefully you will see done message at the end.</p><p>Find whole project in this <a href=https://github.com/nenadfilipovic/esp8266-micropython-ota>repository</a> on github.</p></div></div><div class="footer wrapper"><nav class=nav><div>Version:&nbsp;<a href=/log>2.21</a>&nbsp;|&nbsp;Built with&nbsp;<a href=https://gohugo.io>Hugo</a></div></nav></div><script>feather.replace()</script></body></html>